# Schema v3.1.0 Reference

Complete reference for PrompTrek Universal Prompt Format (UPF) v3.1.0.

## Overview

**Version**: 3.1.0
**Status**: Current
**JSON Schema**: [v3.1.0.json](/schema/v3.1.0.json)

v3.1.0 adds multi-step workflow support and enhanced agent prompts to v3.0.0.

## Top-Level Fields

### Required Fields

#### schema_version

**Type**: `string`
**Required**: Yes

The UPF schema version. Must be `"3.1.0"` or compatible.

```yaml
schema_version: "3.1.0"
```

#### metadata

**Type**: `PromptMetadata` object
**Required**: Yes

Metadata about the prompt file.

```yaml
metadata:
  title: "Project Name"              # Required
  description: "Brief description"   # Required
  version: "1.0.0"                   # Optional
  author: "Author Name"              # Optional
  created: "2024-01-15"              # Optional (YYYY-MM-DD)
  updated: "2024-01-20"              # Optional (YYYY-MM-DD)
  tags: [tag1, tag2]                 # Optional
```

**PromptMetadata Fields**:

- `title` (string, required): Human-readable title
- `description` (string, required): Brief description
- `version` (string, optional): Semantic version
- `author` (string, optional): Author name/email
- `created` (string, optional): Creation date (ISO 8601)
- `updated` (string, optional): Last update date (ISO 8601)
- `tags` (array of strings, optional): Categorization tags

#### content

**Type**: `string` (markdown)
**Required**: Yes

Main markdown content for the prompt.

```yaml
content: |
  # Project Guidelines

  ## Overview
  Project description and guidelines...
```

### Optional Fields

#### content_description

**Type**: `string`
**Default**: `null`

Description for the main content (used in editor frontmatter).

```yaml
content_description: "Main project guidelines"
```

#### content_always_apply

**Type**: `boolean`
**Default**: `null` (treated as `true`)

Whether main content always applies.

```yaml
content_always_apply: true
```

#### variables

**Type**: `object` (string key-value pairs)
**Default**: `null`

Template variables for substitution.

```yaml
variables:
  PROJECT_NAME: "MyApp"
  VERSION: "1.0.0"
  ENVIRONMENT: "development"
```

#### documents

**Type**: `array` of `DocumentConfig` objects
**Default**: `null`

Additional documents for multi-file editors.

```yaml
documents:
  - name: "testing"
    description: "Testing guidelines"
    content: |
      # Testing Guidelines
      ...
    file_globs: "**/*.test.ts"
    always_apply: false
```

**DocumentConfig Fields**:

- `name` (string, required): Document identifier
- `content` (string, required): Markdown content
- `description` (string, optional): Description
- `file_globs` (string, optional): File patterns
- `always_apply` (boolean, optional): Always apply flag

#### mcp_servers

**Type**: `array` of `MCPServer` objects
**Default**: `null`

MCP server configurations (top-level in v3.x).

```yaml
mcp_servers:
  - name: github
    command: npx
    args: ["-y", "@modelcontextprotocol/server-github"]
    env:
      GITHUB_TOKEN: "{{{ GITHUB_TOKEN }}}"
    description: "GitHub integration"
    trust_metadata:
      trusted: true
      trust_level: full
```

**MCPServer Fields**:

- `name` (string, required): Server identifier
- `command` (string, required): Command to start server
- `args` (array of strings, optional): Command arguments
- `env` (object, optional): Environment variables
- `description` (string, optional): Human-readable description
- `trust_metadata` (TrustMetadata, optional): Trust settings

#### commands

**Type**: `array` of `Command` objects
**Default**: `null`

Slash commands and workflows.

```yaml
commands:
  # Simple command
  - name: review
    description: "Code review"
    prompt: "Review the code..."
    output_format: markdown
    requires_approval: false
    examples: ["Review this function"]
    trust_metadata:
      trusted: true

  # Multi-step workflow (v3.1 feature)
  - name: deploy
    description: "Deployment workflow"
    multi_step: true              # v3.1: Mark as workflow
    tool_calls: [git, npm, gh]    # v3.1: Tools used
    prompt: |
      Deploy the application...
    steps:                        # v3.1: Workflow steps
      - name: test
        action: execute_command
        description: "Run tests"
        params:
          command: "npm test"
      - name: build
        action: execute_command
        description: "Build app"
        params:
          command: "npm run build"
```

**Command Fields**:

- `name` (string, required): Command identifier
- `description` (string, required): Command description
- `prompt` (string, required): Prompt template
- `output_format` (string, optional): Expected output format
- `requires_approval` (boolean, default: false): Requires approval
- `system_message` (string, deprecated): Use `prompt` instead
- `examples` (array of strings, optional): Usage examples
- `trust_metadata` (TrustMetadata, optional): Trust settings
- `multi_step` (boolean, default: false): **v3.1**: Multi-step workflow
- `tool_calls` (array of strings, optional): **v3.1**: Tools/commands used
- `steps` (array of WorkflowStep, optional): **v3.1**: Workflow steps

**WorkflowStep Fields** (v3.1):

- `name` (string, required): Step identifier
- `action` (string, required): Action to perform
- `description` (string, optional): Step description
- `params` (object, optional): Action parameters
- `conditions` (object, optional): Execution conditions

#### agents

**Type**: `array` of `Agent` objects
**Default**: `null`

Autonomous agent configurations.

```yaml
agents:
  - name: test-generator
    description: "Generate tests"
    prompt: |                     # v3.1: Use prompt (full markdown)
      # Test Generation Agent
      Comprehensive instructions...
    tools: [file_read, file_write]
    trust_level: partial
    requires_approval: true
    context:
      framework: jest
    trust_metadata:
      trusted: true
```

**Agent Fields**:

- `name` (string, required): Agent identifier
- `description` (string, optional): Agent description  # v3.1: optional (was required in v3.0)
- `prompt` (string, required): **v3.1**: Full markdown instructions
- `tools` (array of strings, optional): Available tools
- `trust_level` (string, default: "untrusted"): Trust level
- `requires_approval` (boolean, default: true): Requires approval
- `context` (object, optional): Additional context
- `trust_metadata` (TrustMetadata, optional): Trust settings

**Note**: In v3.0, agents used `system_prompt`. v3.1 uses `prompt` for richer markdown content.

#### hooks

**Type**: `array` of `Hook` objects
**Default**: `null`

Event-driven automation hooks.

```yaml
hooks:
  - name: pre-commit
    event: pre-commit
    command: "npm test"
    description: "Run tests before commit"
    conditions:
      path: "**/*.ts"
    requires_reapproval: false
    agent: "test-agent"           # v3.1: Associate with agent
    trust_metadata:
      trusted: true
```

**Hook Fields**:

- `name` (string, required): Hook identifier
- `event` (string, required): Event trigger (e.g., 'pre-commit')
- `command` (string, required): Command to execute
- `description` (string, optional): Hook description
- `conditions` (object, optional): Execution conditions
- `requires_reapproval` (boolean, default: true): Requires reapproval
- `agent` (string, optional): **v3.1**: Associated agent name
- `trust_metadata` (TrustMetadata, optional): Trust settings

**Supported Events** (v3.1):
- `pre-commit`, `post-commit`
- `pre-push`, `post-push`
- `pre-merge`, `post-merge`
- `prompt-submit` (editor-specific)
- `agent-spawn` (v3.1: for agent-scoped hooks)

#### ignore_editor_files

**Type**: `boolean`
**Default**: `null` (treated as `true`)

Automatically add editor-specific files to `.gitignore`.

```yaml
ignore_editor_files: true
```

## Shared Types

### TrustMetadata

Security and trust metadata for plugins.

```yaml
trust_metadata:
  trusted: false                  # Default: false
  trust_level: "partial"          # full, partial, untrusted
  requires_approval: true         # Default: true
  source: "official"              # official, community, local
  verified_by: "PrompTrek Team"
  verified_date: "2024-01-15"
```

**Fields**:

- `trusted` (boolean, default: false): Whether trusted
- `trust_level` (string, optional): Trust level
- `requires_approval` (boolean, default: true): Requires approval
- `source` (string, optional): Plugin source
- `verified_by` (string, optional): Verifier
- `verified_date` (string, optional): Verification date (ISO 8601)

## v3.1 New Features

### Multi-Step Workflows

Commands can define structured workflows:

```yaml
commands:
  - name: ci-pipeline
    multi_step: true
    tool_calls: [git, npm, run_tests]
    steps:
      - name: install
        action: execute_command
        params: {command: "npm ci"}
      - name: test
        action: run_tests
        conditions: {exit_code: 0}
```

### Enhanced Agent Prompts

Agents use `prompt` field for full markdown:

```yaml
agents:
  - name: my-agent
    prompt: |                     # v3.1: Full markdown
      # Agent Instructions
      Detailed guidelines...
```

### Agent-Scoped Hooks

Hooks can be associated with specific agents:

```yaml
hooks:
  - name: agent-hook
    event: agent-spawn
    agent: "my-agent"             # v3.1: Hook for specific agent
    command: "setup.sh"
```

## Complete Example

```yaml
schema_version: "3.1.0"

metadata:
  title: "Full-Stack App"
  description: "Complete v3.1.0 example"
  version: "2.0.0"
  author: "Dev Team"
  tags: [typescript, fullstack]

content: |
  # Main Guidelines
  ...

variables:
  PROJECT: "MyApp"
  VERSION: "2.0.0"

documents:
  - name: "testing"
    content: "Testing guidelines..."

mcp_servers:
  - name: github
    command: npx
    args: ["-y", "@modelcontextprotocol/server-github"]

commands:
  # Simple command
  - name: review
    description: "Code review"
    prompt: "Review code..."

  # Multi-step workflow (v3.1)
  - name: deploy
    description: "Deploy app"
    multi_step: true
    tool_calls: [git, npm]
    prompt: "Deploy application..."
    steps:
      - name: test
        action: execute_command
        params: {command: "npm test"}

agents:
  - name: test-gen
    description: "Test generator"
    prompt: |                     # v3.1: Full markdown
      # Test Generator
      Generate comprehensive tests...

hooks:
  - name: pre-commit
    event: pre-commit
    command: "npm test"
    agent: "test-gen"             # v3.1: Agent-scoped

ignore_editor_files: true
```

## Migration from v3.0

v3.1 is fully backward compatible with v3.0:

```yaml
# v3.0 files work in v3.1 without changes
schema_version: "3.0.0"  # Can keep v3.0.0

# To use v3.1 features:
schema_version: "3.1.0"  # Update version

# Optionally enhance agents
agents:
  - name: my-agent
    prompt: |              # Renamed from system_prompt
      # Enhanced markdown content

# Optionally add workflows
commands:
  - name: workflow
    multi_step: true       # New in v3.1
    tool_calls: [...]      # New in v3.1
    steps: [...]           # New in v3.1
```

## See Also

- [Schema v3.1.0 Guide](../user-guide/configuration/schema-v3.1.md)
- [Schema v3.0.0 Reference](v3.0.0.md)
- [Schema Versions Overview](../user-guide/configuration/schema-versions.md)
- [Migration Guide](../user-guide/workflows/migration.md)
