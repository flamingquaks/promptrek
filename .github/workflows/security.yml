name: Reusable Security Workflow
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.12'
      bandit-severity:
        required: false
        type: string
        default: 'medium'
      fail-on-issues:
        required: false
        type: boolean
        default: false
  push:
    tags:
      - '*-rc*'

jobs:
  # Security scan for RC tags (uses API)
  security-scan-rc:
    if: github.ref_type == 'tag' && contains(github.ref_name, '-rc')
    continue-on-error: true
    runs-on: ubuntu-latest
    environment: safety

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python ${{ inputs.python-version || '3.12' }}
        run: uv python install ${{ inputs.python-version || '3.12' }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-security-${{ inputs.python-version || '3.12' }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-security-${{ inputs.python-version || '3.12' }}-
            ${{ runner.os }}-uv-security-

      - name: Install security tools
        run: |
          uv add --group dev bandit safety pip-audit
          uv sync --group dev

      - name: Run Bandit security linter
        run: |
          echo "Running Bandit security analysis..."

          # Set severity level
          if [ "${{ inputs.bandit-severity }}" = "high" ]; then
            SEVERITY="-lll"
          elif [ "${{ inputs.bandit-severity }}" = "medium" ]; then
            SEVERITY="-ll"
          else
            SEVERITY="-l"
          fi

          # Run bandit and capture results
          uv run bandit -r src/ ${SEVERITY} -f json -o bandit-report.json || true
          uv run bandit -r src/ ${SEVERITY} || true

      - name: Run pip-audit for dependency vulnerabilities
        run: |
          echo "Running pip-audit for dependency vulnerabilities..."
          uv run pip-audit || true
        continue-on-error: true

      - name: Check for known vulnerabilities with Safety (API scan for RC tags)
        run: |
          echo "Checking for known vulnerabilities in dependencies..."
          set +e
          uv run safety scan --output json > safety-report.json 2>&1
          SAFETY_EXIT_CODE=$?
          set -e

          # Display results from JSON output
          if [ -f safety-report.json ]; then
            echo "Safety scan completed. Results saved to safety-report.json"
            cat safety-report.json | python -m json.tool || cat safety-report.json || true
          fi

          # Check if we should fail on issues
          if [ "${{ inputs.fail-on-issues || 'false' }}" = "true" ] && [ $SAFETY_EXIT_CODE -ne 0 ]; then
            exit 1
          fi
        continue-on-error: ${{ inputs.fail-on-issues == false || inputs.fail-on-issues == '' }}

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-rc-${{ github.run_id }}
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Security scan summary
        if: always()
        run: |
          echo "## Security Scan Summary"
          echo ""

          if [ -f bandit-report.json ]; then
            BANDIT_ISSUES=$(python -c \
              "import json; data = json.load(open('bandit-report.json')); print(len(data.get('results', [])))" \
              2>/dev/null || echo "0")
            echo "- Bandit: Found $BANDIT_ISSUES potential security issues"
          fi

          if [ -f safety-report.json ]; then
            echo "- Safety: Vulnerability check completed"
          fi

          echo ""
          echo "Security scan completed. Check artifacts for detailed reports."

  # Security scan for release tags (vx.x.x without suffix) - uses API
  security-scan-release:
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v') && !contains(github.ref_name, '-')
    runs-on: ubuntu-latest
    environment: safety
    continue-on-error: true
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python ${{ inputs.python-version || '3.12' }}
        run: uv python install ${{ inputs.python-version || '3.12' }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-security-${{ inputs.python-version || '3.12' }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-security-${{ inputs.python-version || '3.12' }}-
            ${{ runner.os }}-uv-security-

      - name: Install security tools
        run: |
          uv add --group dev bandit safety pip-audit
          uv sync --group dev

      - name: Run Bandit security linter
        run: |
          echo "Running Bandit security analysis..."

          # Set severity level
          if [ "${{ inputs.bandit-severity }}" = "high" ]; then
            SEVERITY="-lll"
          elif [ "${{ inputs.bandit-severity }}" = "medium" ]; then
            SEVERITY="-ll"
          else
            SEVERITY="-l"
          fi

          # Run bandit and capture results
          uv run bandit -r src/ ${SEVERITY} -f json -o bandit-report.json || true
          uv run bandit -r src/ ${SEVERITY} || true

      - name: Run pip-audit for dependency vulnerabilities
        run: |
          echo "Running pip-audit for dependency vulnerabilities..."
          uv run pip-audit || true
        continue-on-error: true

      - name: Check for known vulnerabilities with Safety (API scan for releases)
        run: |
          echo "Checking for known vulnerabilities in dependencies..."
          set +e
          uv run safety scan --output json > safety-report.json 2>&1
          SAFETY_EXIT_CODE=$?
          set -e

          # Display results from JSON output
          if [ -f safety-report.json ]; then
            echo "Safety scan completed. Results saved to safety-report.json"
            cat safety-report.json | python -m json.tool || cat safety-report.json || true
          fi

          # Check if we should fail on issues
          if [ "${{ inputs.fail-on-issues || 'false' }}" = "true" ] && [ $SAFETY_EXIT_CODE -ne 0 ]; then
            exit 1
          fi
        continue-on-error: ${{ inputs.fail-on-issues == false || inputs.fail-on-issues == '' }}

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-release-${{ github.run_id }}
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Security scan summary
        if: always()
        run: |
          echo "## Security Scan Summary"
          echo ""

          if [ -f bandit-report.json ]; then
            BANDIT_ISSUES=$(python -c \
              "import json; data = json.load(open('bandit-report.json')); print(len(data.get('results', [])))" \
              2>/dev/null || echo "0")
            echo "- Bandit: Found $BANDIT_ISSUES potential security issues"
          fi

          if [ -f safety-report.json ]; then
            echo "- Safety: Vulnerability check completed"
          fi

          echo ""
          echo "Security scan completed. Check artifacts for detailed reports."

  # Security scan for CI/PRs and other tags (beta, alpha, dev, etc.) - no API
  security-scan:
    if: |
      github.ref_type != 'tag' ||
      (github.ref_type == 'tag' && contains(github.ref_name, '-') && !contains(github.ref_name, '-rc'))
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python ${{ inputs.python-version || '3.12' }}
        run: uv python install ${{ inputs.python-version || '3.12' }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-security-${{ inputs.python-version || '3.12' }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-security-${{ inputs.python-version || '3.12' }}-
            ${{ runner.os }}-uv-security-

      - name: Install security tools
        run: |
          uv add --group dev bandit safety pip-audit
          uv sync --group dev

      - name: Run Bandit security linter
        run: |
          echo "Running Bandit security analysis..."

          # Set severity level
          if [ "${{ inputs.bandit-severity }}" = "high" ]; then
            SEVERITY="-lll"
          elif [ "${{ inputs.bandit-severity }}" = "medium" ]; then
            SEVERITY="-ll"
          else
            SEVERITY="-l"
          fi

          # Run bandit and capture results
          uv run bandit -r src/ ${SEVERITY} -f json -o bandit-report.json || true
          uv run bandit -r src/ ${SEVERITY} || true

          # Check if we should fail on issues
          if [ "${{ inputs.fail-on-issues }}" = "true" ]; then
            # Parse JSON to check for issues
            if [ -f bandit-report.json ]; then
              ISSUE_COUNT=$(python -c \
                "import json; data = json.load(open('bandit-report.json')); print(len(data.get('results', [])))" \
                2>/dev/null || echo "0")
              if [ "$ISSUE_COUNT" -gt "0" ]; then
                echo "Found $ISSUE_COUNT security issues"
                exit 1
              fi
            fi
          fi

      - name: Run pip-audit for dependency vulnerabilities
        run: |
          echo "Running pip-audit for dependency vulnerabilities..."
          uv run pip-audit || true

          # Check if we should fail on issues
          if [ "${{ inputs.fail-on-issues }}" = "true" ]; then
            uv run pip-audit || exit 1
          fi
        continue-on-error: ${{ !inputs.fail-on-issues }}

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: |
            bandit-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Security scan summary
        if: always()
        run: |
          echo "## Security Scan Summary"
          echo ""

          if [ -f bandit-report.json ]; then
            BANDIT_ISSUES=$(python -c \
              "import json; data = json.load(open('bandit-report.json')); print(len(data.get('results', [])))" \
              2>/dev/null || echo "0")
            echo "- Bandit: Found $BANDIT_ISSUES potential security issues"
          fi

          echo ""
          echo "Security scan completed. Check artifacts for detailed reports."
