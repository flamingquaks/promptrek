name: VSCode Extension Package

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'vscode-extension/**'
  workflow_dispatch:

jobs:
  package-extension:
    name: Package Extension for Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Get extension version
        id: version
        working-directory: vscode-extension
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $VERSION"

      - name: Install dependencies
        working-directory: vscode-extension
        run: npm ci

      - name: Run linter
        working-directory: vscode-extension
        run: npm run lint
        continue-on-error: true

      - name: Compile TypeScript
        working-directory: vscode-extension
        run: npm run compile

      - name: Verify compilation
        working-directory: vscode-extension
        run: |
          if [ -d "out" ]; then
            echo "âœ“ Compilation successful"
            echo "Compiled files:"
            find out -name "*.js" | head -20
          else
            echo "âœ— Compilation failed"
            exit 1
          fi

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package extension
        working-directory: vscode-extension
        run: |
          vsce package --out promptrek-vscode-${{ steps.version.outputs.version }}-pr${{ github.event.number }}.vsix
          echo "ðŸ“¦ Package created successfully"

      - name: Get package info
        working-directory: vscode-extension
        run: |
          VSIX_FILE=$(ls *.vsix)
          VSIX_SIZE=$(stat -f%z "$VSIX_FILE" 2>/dev/null || stat -c%s "$VSIX_FILE")
          VSIX_SIZE_MB=$((VSIX_SIZE / 1024 / 1024))

          echo "## Extension Package Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** $VSIX_FILE" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** ${VSIX_SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-package-pr${{ github.event.number }}
          path: vscode-extension/*.vsix
          retention-days: 30

      - name: Test extension package
        working-directory: vscode-extension
        run: |
          echo "Testing extension package contents..."
          VSIX_FILE=$(ls *.vsix)
          unzip -l "$VSIX_FILE" | grep -E "\.(js|json)$" | head -20

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the VSIX file
            const vsixFiles = fs.readdirSync('vscode-extension').filter(f => f.endsWith('.vsix'));
            const vsixFile = vsixFiles[0];
            const stats = fs.statSync(path.join('vscode-extension', vsixFile));
            const sizeMB = (stats.size / 1024 / 1024).toFixed(2);

            const comment = `## ðŸ“¦ Extension Package Ready

            A VSIX package has been created for this PR and is available as a build artifact.

            ### Package Details
            - **File:** \`${vsixFile}\`
            - **Size:** ${sizeMB} MB
            - **Version:** ${{ steps.version.outputs.version }}

            ### Installation
            1. Download the artifact from the workflow run
            2. Extract the VSIX file
            3. Install with: \`code --install-extension ${vsixFile}\`

            ### Testing
            After installation, you can test the extension by:
            1. Opening a workspace with PrompTrek configuration
            2. Checking the PrompTrek sidebar
            3. Running commands from the Command Palette

            ---
            *This package is for review purposes only and is not published to the marketplace.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  analyze-bundle:
    name: Analyze Extension Bundle
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Install dependencies
        working-directory: vscode-extension
        run: npm ci

      - name: Analyze dependencies
        working-directory: vscode-extension
        run: |
          echo "## Dependency Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Production Dependencies" >> $GITHUB_STEP_SUMMARY
          npm list --prod --depth=0 >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency Tree" >> $GITHUB_STEP_SUMMARY
          npm list --prod >> $GITHUB_STEP_SUMMARY 2>&1 || true

      - name: Check for vulnerabilities
        working-directory: vscode-extension
        run: |
          echo "### Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY 2>&1 || true

      - name: Check bundle size
        working-directory: vscode-extension
        run: |
          npm run compile
          TOTAL_SIZE=$(du -sh out | cut -f1)
          JS_COUNT=$(find out -name "*.js" | wc -l)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Compiled size:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **JavaScript files:** $JS_COUNT" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Largest Files" >> $GITHUB_STEP_SUMMARY
          find out -name "*.js" -exec du -h {} + | sort -rh | head -10 >> $GITHUB_STEP_SUMMARY
